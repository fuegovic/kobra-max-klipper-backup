####################################################################
# 00_Print workflow
####################################################################
[gcode_macro START_PRINT]
description: Prepare printer, heat bed/nozzle, home, load mesh, purge line, and begin print
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}

    M117 Heating bed and nozzle
    M140 S{BED_TEMP}                 ; start heating bed
    M104 S{EXTRUDER_TEMP}            ; start heating nozzle

    G90                              ; absolute positioning
    G21                              ; metric units
    M82                              ; absolute extrusion mode
    SET_PIN PIN=LED VALUE=1.0        ; lights on

    SET_GCODE_OFFSET Z=0.0           ; reset offsets
    G92 E0                           ; reset extruder

    G28                              ; home all axes

    M190 S{BED_TEMP}                 ; wait for bed
    M109 S{EXTRUDER_TEMP}            ; wait for nozzle

    BED_MESH_PROFILE LOAD=default    ; load mesh

    G1 Z10 F3000                     ; lift clear of bed

    ; --- Purge line along front edge (more predictable than a blob) ---
    G1 X20 Y10 Z0.3 F5000.0          ; move to front-left inside printable area
    G1 E8 F300                       ; prime
    G4 P500
    G1 X360 Y10 E40 F1200            ; purge line across front edge (adjust X to your bed)
    G1 E-1 F600                      ; slight retract
    G1 Z2 F3000                      ; lift away

    G92 E0                           ; reset extruder
    G1 X20 Y20 F5000.0               ; move inside bed, ready to print

[gcode_macro END_PRINT]
description: Safely finish print — retract, lift nozzle, cool heaters, move bed forward
gcode:
    # Turn off heaters and fan
    M140 S0                          ; bed off
    M104 S0                          ; hotend off
    M106 S0                          ; part cooling fan off
    M117 Print complete

    # Retract filament once to relieve pressure
    G91                              ; relative moves
    G1 E-3 F2400                     ; retract 3 mm at 40 mm/s

    # Raise nozzle clear of print
    G1 Z20 F1000                     ; lift Z by 20 mm
    G90                              ; back to absolute

    # Move bed forward for easy part removal
    G0 X0 Y{printer.configfile.config["stepper_y"]["position_max"]|float - 5} F6000

    M84                              ; Disable steppers

####################################################################
# 20_Filament & Material
####################################################################
[gcode_macro FILAMENT_CHANGE]
description: Pause print and run a filament change workflow (heat, retract, park head)
gcode:
    M117 Filament change requested
    PAUSE
    G91
    G1 Z10 F1000
    G90
    G1 X10 Y10 F6000
    M117 Unload/replace filament then resume

[gcode_macro LOAD_FILAMENT]
description: Heat nozzle and feed filament into hotend until primed
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = 1500 %}        ; safe max feedrate for direct drive

    SAVE_GCODE_STATE NAME=load_state
    M109 S220                            ; heat nozzle to 220°C for loading

    G91                                  ; relative moves
    G92 E0
    G1 E100 F{max_velocity}              ; push ~100 mm quickly
    G1 E20 F{speed}                      ; slow purge to fully prime
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
description: Heat nozzle and retract filament fully for removal
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = 1500 %}        ; safe max feedrate for direct drive

    SAVE_GCODE_STATE NAME=unload_state
    M109 S220                            ; heat nozzle to 220°C for unloading

    G91                                  ; relative moves
    G92 E0
    G1 E10 F{speed}                      ; small purge to soften tip
    G1 E-120 F{max_velocity}             ; retract ~120 mm (direct drive safe)
    RESTORE_GCODE_STATE NAME=unload_state

####################################################################
# 30_Maintenance & Tests
###################################################################
[gcode_macro TEST_FANS]
description: Spin fans at various speeds for testing; use params SLOW/FAST (0-255)
gcode:
    {% set slow = params.SLOW|default(100)|int %}
    {% set fast = params.FAST|default(255)|int %}
    M117 Testing fans
    M106 S{slow}            ; main fan (pin PB9)
    G4 P1000
    M106 S{fast}
    G4 P1000
    M106 S0
    M117 Fan test complete

[gcode_macro CLEAR_BED_MESH]
description: Clear current bed mesh data from memory
gcode:
    BED_MESH_CLEAR
    M117 Bed mesh cleared

[gcode_macro HOME_ALL]
description: Home all axes cleanly (G28 wrapper)
gcode:
    M117 Homing all axes
    G28
    M117 Homing complete

[gcode_macro PROBE_RESET]
description: Reset probe by toggling its reset pin (use when probe locks)
gcode:
    SET_PIN PIN=probe_reset_pin VALUE=1
    G4 P500
    SET_PIN PIN=probe_reset_pin VALUE=0
    G4 P100
    M117 Probe reset toggle complete
    
#####################################################################
# Calibration Macros
# These live in macros.cfg to keep printer.cfg clean and hardware-only
#####################################################################

[gcode_macro CALIBRATE_PROBE]
description: Run Klipper's probe calibration routine and save result
gcode:
    G28                              ; always home before probing
    PROBE_CALIBRATE                  ; interactive probe calibration
    SAVE_CONFIG                      ; write z_offset to config

[gcode_macro CALIBRATE_BED_MESH]
description: Run a full bed mesh calibration and save result
gcode:
    G28                              ; home all axes first
    BED_MESH_CALIBRATE               ; interactive mesh probing
    SAVE_CONFIG                      ; save mesh profile as "default"

[gcode_macro QUICK_BED_MESH]
description: Fast mesh probe (no heating) for quick checks
gcode:
    G28                              ; home all axes
    BED_MESH_CLEAR                   ; clear any existing mesh
    BED_MESH_CALIBRATE               ; probe mesh
    BED_MESH_PROFILE SAVE=quick      ; save as "quick" profile
    M117 Quick mesh complete

[gcode_macro WARMUP_BED_MESH]
description: Heat bed/nozzle, wait, then run a full mesh for accuracy
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set NOZZLE_TEMP = params.NOZZLE_TEMP|default(150)|float %}
    ; Default: bed 60°C, nozzle 150°C (hot enough to simulate expansion, but not ooze)

    M117 Heating for mesh...
    M140 S{BED_TEMP}                 ; start heating bed
    M104 S{NOZZLE_TEMP}              ; start heating nozzle
    M190 S{BED_TEMP}                 ; wait for bed
    M109 S{NOZZLE_TEMP}              ; wait for nozzle

    G28                              ; home all axes
    BED_MESH_CLEAR                   ; clear any existing mesh
    BED_MESH_CALIBRATE               ; probe mesh
    SAVE_CONFIG                      ; save mesh profile as "default"
    M117 Warm mesh complete

####################################################################
# 40_Tuning Helpers (resonance / input shaper)
# Note: you currently do not have an accelerometer configured.
# If/when you add one, follow the commented example below and then run resonance_tune.
####################################################################

# Example accelerometer (commented): ADXL345 on I2C
# Add to printer.cfg (not this file) if you install an accel:
# [adxl345 my_adxl]
# cs_pin: <leave blank for I2C>
# i2c_bus: i2c1
# i2c_miso_pin:
# i2c_mosi_pin:
# i2c_scl_pin: <your board SCL>
# i2c_sda_pin: <your board SDA>
# Note: exact pin names depend on your board; check Klipper docs for correct syntax.

[gcode_macro PA_TUNING_TOWER]
description: Run a pressure advance tuning tower using Klipper's TUNING_TOWER
gcode:
    {% set start = params.START|default(0)|float %}
    {% set step = params.STEP|default(0.005)|float %}
    {% set height = params.HEIGHT|default(40)|int %}
    M117 Starting PA tuning tower
    TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START={start} FACTOR={step} HEIGHT={height}
    M117 PA tuning tower started

[gcode_macro RESONANCE_TEST]
description: Run resonance tuning (requires accelerometer). Edit to match your accel name or uncomment accel section in printer.cfg
gcode:
    M117 Resonance tuning starting
    # If you have an accel configured, run:
    # resonance_tune
    # After resonance_tune finishes it prints suggested input_shaper settings
    M117 Resonance tune dispatched - run resonance_tune if accel is configured

[gcode_macro INPUT_SHAPER_SAVE]
description: Save input_shaper settings into config after tuning (runs SAVE_CONFIG)
gcode:
    M117 Saving input-shaper settings (ensure input_shaper section updated first)
    SAVE_CONFIG
    M117 Input-shaper save requested

# Optional template you can paste into printer.cfg after tuning:
# [input_shaper]
# shaper_type: mzv
# shaper_freq_x: 40.0
# shaper_freq_y: 38.5
# damping: 0.1
# (Replace values with those printed by resonance_tune; then run SAVE_CONFIG)

####################################################################
# 50_UI / Convenience
####################################################################
[gcode_macro LED_ON]
description: Turn status LED(s) on (pin PB8)
gcode:
    SET_PIN PIN=LED VALUE=1.0
    M117 LED on

[gcode_macro LED_OFF]
description: Turn status LED(s) off (pin PB8)
gcode:
    SET_PIN PIN=LED VALUE=0.0
    M117 LED off

[gcode_macro SNAPSHOT_CAMERA]
description: Trigger a camera snapshot. Tries TAKE_PHOTO first; fallback to MJPG snapshot via ustreamer (port 8080)
gcode:
    M117 Snapshot requested
    # Primary: Moonraker / UI TAKE_PHOTO (supported by many setups)
    TAKE_PHOTO
    # If TAKE_PHOTO is not available in your setup, uncomment the following alternate command:
    # (Replace 127.0.0.1 with your Pi/host if different)
    # RESPOND PREFIX="CAM" MSG="MJPG snapshot via ustreamer (HTTP)"
    # RESPOND PREFIX="CAM" MSG="Use external curl/wget: http://127.0.0.1:8080/action/snapshot"
    M117 Snapshot command dispatched

[gcode_macro STATUS_REPORT]
description: Print a short status report (temperatures, bed mesh profile list)
gcode:
    M117 Status report
    TEMPERATURES
    BED_MESH_PROFILE LIST
    M117 Status report complete

####################################################################
# 90_Tuning extras (optional; include only while tuning if you want)
# You can move these to tuning.cfg and include it during tuning sessions.
####################################################################
[gcode_macro SAVE_CONFIG_AND_RESTART]
description: Save current config (including tuned values) and restart Klipper
gcode:
    SAVE_CONFIG
    RESTART