#####################################################################
# Calibration Macros
# These live in macros.cfg to keep printer.cfg clean and hardware-only
#####################################################################

[gcode_macro CALIBRATE_PROBE]
description: Run Klipper's probe calibration routine and save result
gcode:
    G28                              ; always home before probing
    PROBE_CALIBRATE                  ; interactive probe calibration
    SAVE_CONFIG                      ; write z_offset to config

[gcode_macro CALIBRATE_BED_MESH]
description: Run a full bed mesh calibration and save result
gcode:
    G28                              ; home all axes first
    BED_MESH_CALIBRATE               ; interactive mesh probing
    SAVE_CONFIG                      ; save mesh profile as "default"

#####################################################################
# Bed Mesh Variants
#####################################################################

[gcode_macro QUICK_BED_MESH]
description: Fast mesh probe (no heating) for quick checks
gcode:
    G28                              ; home all axes
    BED_MESH_CLEAR                   ; clear any existing mesh
    BED_MESH_CALIBRATE               ; probe mesh
    BED_MESH_PROFILE SAVE=quick      ; save as "quick" profile
    M117 Quick mesh complete

[gcode_macro WARMUP_BED_MESH]
description: Heat bed/nozzle, wait, then run a full mesh for accuracy
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set NOZZLE_TEMP = params.NOZZLE_TEMP|default(150)|float %}
    ; Default: bed 60°C, nozzle 150°C (hot enough to simulate expansion, but not ooze)

    M117 Heating for mesh...
    M140 S{BED_TEMP}                 ; start heating bed
    M104 S{NOZZLE_TEMP}              ; start heating nozzle
    M190 S{BED_TEMP}                 ; wait for bed
    M109 S{NOZZLE_TEMP}              ; wait for nozzle

    G28                              ; home all axes
    BED_MESH_CLEAR                   ; clear any existing mesh
    BED_MESH_CALIBRATE               ; probe mesh
    BED_MESH_PROFILE SAVE=default    ; overwrite "default" profile
    M117 Warm mesh complete

#####################################################################
# Start/End Print
#####################################################################

[gcode_macro START_PRINT]
description: Prepare printer, heat bed/nozzle, home, load mesh, purge line, and begin print
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}

    M117 Heating bed and nozzle
    M140 S{BED_TEMP}                 ; start heating bed
    M104 S{EXTRUDER_TEMP}            ; start heating nozzle

    G90                              ; absolute positioning
    G21                              ; metric units
    M82                              ; absolute extrusion mode
    SET_PIN PIN=LED VALUE=1.0        ; lights on

    SET_GCODE_OFFSET Z=0.0           ; reset offsets
    G92 E0                           ; reset extruder

    G28                              ; home all axes

    M190 S{BED_TEMP}                 ; wait for bed
    M109 S{EXTRUDER_TEMP}            ; wait for nozzle

    BED_MESH_PROFILE LOAD=default    ; load mesh

    G1 Z10 F3000                     ; lift clear of bed

    ; --- Purge line along front edge (more predictable than a blob) ---
    G1 X20 Y10 Z0.3 F5000.0          ; move to front-left inside printable area
    G1 E8 F300                       ; prime
    G4 P500
    G1 X360 Y10 E40 F1200            ; purge line across front edge (adjust X to your bed)
    G1 E-1 F600                      ; slight retract
    G1 Z2 F3000                      ; lift away

    G92 E0                           ; reset extruder
    G1 X20 Y20 F5000.0               ; move inside bed, ready to print

[gcode_macro END_PRINT]
description: Safely finish print — retract, lift nozzle, cool heaters, move bed forward
gcode:
    # Turn off heaters and fan
    M140 S0                          ; bed off
    M104 S0                          ; hotend off
    M106 S0                          ; part cooling fan off
    M117 Print complete

    # Retract filament once to relieve pressure
    G91                              ; relative moves
    G1 E-3 F2400                     ; retract 3 mm at 40 mm/s

    # Raise nozzle clear of print
    G1 Z20 F1000                     ; lift Z by 20 mm
    G90                              ; back to absolute

    # Move bed forward for easy part removal
    G0 X0 Y{printer.configfile.config["stepper_y"]["position_max"]|float - 5} F6000

    M84                              ; Disable steppers

#####################################################################
# Filament
#####################################################################

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = 1500 %}        ; safe max feedrate for direct drive

    SAVE_GCODE_STATE NAME=unload_state
    M109 S220                            ; heat nozzle to 220°C for unloading

    G91                                  ; relative moves
    G92 E0
    G1 E10 F{speed}                      ; small purge to soften tip
    G1 E-120 F{max_velocity}             ; retract ~120 mm (direct drive safe)
    RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = 1500 %}        ; safe max feedrate for direct drive

    SAVE_GCODE_STATE NAME=load_state
    M109 S220                            ; heat nozzle to 220°C for loading

    G91                                  ; relative moves
    G92 E0
    G1 E100 F{max_velocity}              ; push ~100 mm quickly
    G1 E20 F{speed}                      ; slow purge to fully prime
    RESTORE_GCODE_STATE NAME=load_state

#####################################################################
# Probe
#####################################################################

[gcode_macro probe_reset]
gcode:
    SET_PIN PIN=probe_reset_pin VALUE=1
    G4 P500
    SET_PIN PIN=probe_reset_pin VALUE=0
    G4 P100