####################################################################
# 1 - Print workflow
####################################################################

[gcode_macro START_PRINT]
description: Prepare printer, heat bed/nozzle, home, load mesh, purge line, and begin print
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set pause_after_mesh = params.PAUSE|default(False) %}

    M117 Heating bed and nozzle
    M140 S{BED_TEMP}                 ; start heating bed
    M104 S{EXTRUDER_TEMP}            ; start heating nozzle

    G90                              ; absolute positioning
    G21                              ; metric units
    M82                              ; absolute extrusion mode
    SET_PIN PIN=LED VALUE=1.0        ; lights on

    SET_GCODE_OFFSET Z=0.0           ; reset offsets
    G92 E0                           ; reset extruder

    G28                              ; home all axes

    M190 S{BED_TEMP}                 ; wait for bed
    M109 S{EXTRUDER_TEMP}            ; wait for nozzle

    # BED_MESH_PROFILE LOAD=default    ; load mesh
    EXCLUDE_OBJECT_DEFINE
    BED_MESH_CALIBRATE
    
    G1 Z10 F3000                     ; lift clear of bed

    VORON_PURGE

    # ; --- Purge line along front edge (uses printer X max) ---
    # ; move to front-left inside printable area
    # G1 X20 Y10 Z0.3 F5000.0
    # G1 E8 F300                       ; prime
    # G4 P500
    # G1 X{printer.toolhead.axis_maximum.x|float - 20} Y10 E40 F1200 ; purge line across front edge
    # G1 E-1 F600                      ; slight retract
    # G1 Z2 F3000                      ; lift away

    G92 E0                           ; reset extruder
    SMART_PARK
    # G1 X20 Y20 F5000.0               ; move inside bed, ready to print
    BEEP_SHORT
    M117 Print Started! 

[gcode_macro END_PRINT]
description: Safely finish print — retract, lift nozzle 60mm, cool heaters, park, then power off
gcode:
    {% set RAISE_MM = 60 %}
    {% set PARK_X = printer.toolhead.axis_maximum.x|float - 5 %}
    {% set PARK_Y = printer.toolhead.axis_maximum.y|float - 5 %}

    RESPOND TYPE=command MSG="END_PRINT: starting shutdown sequence"

    # Request cooling and update UI
    M140 S0
    M104 S0
    M106 S0
    M117 Print complete

    # Retract filament to relieve pressure
    G91
    G1 E-3 F2400
    G90

    # Raise nozzle by RAISE_MM relative to current height (safe clearance above print)
    G91
    G1 Z{RAISE_MM} F1000
    G90

    # Wait for moves to finish and let temps begin to drop
    M400
    G4 P2000

    # Move to a safe park position at the far corner
    G0 X{PARK_X} Y{PARK_Y} F6000
    M400
    G4 P500

    # Visual/sonic confirmation
    SET_PIN PIN=LED VALUE=0.0
    BEEP_LONG
    M117 Print Completed!

    RESPOND TYPE=command MSG="END_PRINT: calling POWER_OFF"

    # Call the single-source power-off macro. Do not M84 before POWER_OFF if power will be cut immediately.
    POWER_OFF

####################################################################
# Pause with audible alert
####################################################################
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
description: Pause print and play alert beeps
gcode:
    BASE_PAUSE
    # Optional: park head safely
    G91
    G1 Z10 F600          ; lift nozzle 10mm
    G90
    G1 X10 Y10 F6000     ; move to front-left (adjust as desired)
    # Audible alert
    BEEP_ALERT

####################################################################
# Cancel print with error beep
####################################################################
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
description: Cancel print and play error beeps
gcode:
    BASE_CANCEL_PRINT
    # Optional: move bed forward for access
    G91
    G1 Z10 F600
    G90
    G1 X0 Y200 F6000     ; adjust to your printer’s safe park
    # Audible error alert
    BEEP_ERROR


####################################################################
# 2 - Filament load/unload (safe, saves/restores gcode state)
####################################################################
[gcode_macro LOAD_FILAMENT]
description: Heat nozzle and feed filament into hotend until primed
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = params.MAX_VELOCITY|default(1500)|int %}
    {% set temp = params.TEMP|default(220)|int %}

    SAVE_GCODE_STATE NAME=load_state
    M117 Loading filament
    M109 S{temp}                       ; wait for load temp

    G91                                  ; relative moves
    G92 E0
    G1 E100 F{max_velocity}              ; push ~100 mm quickly (adjust for your setup)
    G1 E20 F{speed}                      ; slow purge to fully prime
    RESTORE_GCODE_STATE NAME=load_state
    SET_PIN PIN=LED VALUE=0.0

[gcode_macro UNLOAD_FILAMENT]
description: Heat nozzle and retract filament fully for removal
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = params.MAX_VELOCITY|default(1500)|int %}
    {% set temp = params.TEMP|default(220)|int %}

    SAVE_GCODE_STATE NAME=unload_state
    M117 Unloading filament
    M109 S{temp}                           ; heat nozzle to unload temp

    G91                                  ; relative moves
    G92 E0
    G1 E10 F{speed}                      ; small purge to soften tip
    G1 E-50 F{max_velocity}             ; retract ~50 mm (adjust distance if needed)
    RESTORE_GCODE_STATE NAME=unload_state
    SET_PIN PIN=LED VALUE=0.0

[gcode_macro FILAMENT_CHANGE]
description: Pause print and run a filament change workflow (heat, retract, park head)
gcode:
    M117 Filament change requested
    PAUSE
    BEEP_DOUBLE
    G91
    G1 Z10 F1000
    G90
    G1 X10 Y10 F6000
    M117 Unload/replace filament then resume

####################################################################
# 3 - Mesh & Calibration
####################################################################
[gcode_macro CLEAR_BED_MESH]
description: Clear current bed mesh data from memory
gcode:
    BED_MESH_CLEAR
    M117 Bed mesh cleared

[gcode_macro CALIBRATE_PROBE] 
description: Run Klipper's probe calibration routine and save result 
gcode: 
  G28 ; always home before probing 
  PROBE_CALIBRATE ; interactive probe calibration 
  SAVE_CONFIG

[gcode_macro  MESH_QUICK_SAVE]
description: Run a full bed mesh calibration, COLD, and save result
gcode:
    G28                              ; home all axes first
    BED_MESH_CALIBRATE               ; interactive mesh probing
    SAVE_CONFIG                      ; save mesh profile as "default"
    M117 Mesh calibration complete

[gcode_macro MESH_HOT_LEVEL]
description: Heat, level gantry, probe mesh (flexible temps, no auto-save)
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set NOZZLE_TEMP = params.NOZZLE_TEMP|default(150)|float %}

    M117 Heating for mesh...
    M140 S{BED_TEMP}
    M104 S{NOZZLE_TEMP}
    M190 S{BED_TEMP}
    M109 S{NOZZLE_TEMP}

    G28
    Z_TILT_ADJUST
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
    SAVE_CONFIG
    M117 Mesh calibration complete

[gcode_macro MESH_SMART]
description: Smart mesh — full bed by default, or adaptive area mesh if bounds are given
variable_parameter_AREA_START : 0,0
variable_parameter_AREA_END : 0,0
variable_mesh_area_offset : 5.0
variable_probe_samples : 2
variable_min_probe_count : 4
variable_probe_count_scale_factor : 1.0
variable_enable_reference_index : False
gcode:
    {% if params.AREA_START and params.AREA_END %}
        {% set bedMeshConfig = printer["configfile"].config["bed_mesh"] %}
        {% set safe_min_x = bedMeshConfig.mesh_min.split(",")[0]|float %}
        {% set safe_min_y = bedMeshConfig.mesh_min.split(",")[1]|float %}
        {% set safe_max_x = bedMeshConfig.mesh_max.split(",")[0]|float %}
        {% set safe_max_y = bedMeshConfig.mesh_max.split(",")[1]|float %}

        {% set area_min_x = params.AREA_START.split(",")[0]|float %}
        {% set area_min_y = params.AREA_START.split(",")[1]|float %}
        {% set area_max_x = params.AREA_END.split(",")[0]|float %}
        {% set area_max_y = params.AREA_END.split(",")[1]|float %}

        {% if bedMeshConfig.probe_count.split(",")|length == 2 %}
            {% set meshPointX = bedMeshConfig.probe_count.split(",")[0]|int %}
            {% set meshPointY = bedMeshConfig.probe_count.split(",")[1]|int %}
        {% else %}
            {% set meshPointX = bedMeshConfig.probe_count.split(",")[0]|int %}
            {% set meshPointY = bedMeshConfig.probe_count.split(",")[0]|int %}
        {% endif %}

        {% set meshMaxPointX = meshPointX %}
        {% set meshMaxPointY = meshPointY %}


        {% if (area_min_x < area_max_x) and (area_min_y < area_max_y) %}
            {% if area_min_x - mesh_area_offset >=  safe_min_x %}
                {% set area_min_x = area_min_x - mesh_area_offset %}
            {% else %}
                {% set area_min_x = safe_min_x %}
            {% endif %}

            {% if area_min_y - mesh_area_offset >=  safe_min_y %}
                {% set area_min_y = area_min_y - mesh_area_offset %}
            {% else %}
                {% set area_min_y = safe_min_y %}
            {% endif %}

            {% if area_max_x + mesh_area_offset <=  safe_max_x %}
                {% set area_max_x = area_max_x + mesh_area_offset %}
            {% else %}
                {% set area_max_x = safe_max_x %}
            {% endif %}

            {% if area_max_y + mesh_area_offset <=  safe_max_y %}
                {% set area_max_y = area_max_y + mesh_area_offset %}
            {% else %}
                {% set area_max_y = safe_max_y %}
            {% endif %}

            {% set meshPointX = (meshPointX * (area_max_x - area_min_x) / (safe_max_x - safe_min_x) * probe_count_scale_factor)|round(0)|int %}
            {% if meshPointX < min_probe_count %}
                {% set meshPointX = min_probe_count %}
            {% endif %}
            {% if meshPointX > meshMaxPointX %}
                {% set meshPointX = meshMaxPointX %}
            {% endif %}

            {% set meshPointY = (meshPointY * (area_max_y -area_min_y ) / (safe_max_y - safe_min_y) * probe_count_scale_factor )|round(0)|int %}
            {% if meshPointY < min_probe_count %}
                {% set meshPointY = min_probe_count %}
            {% endif %}
            {% if meshPointY > meshMaxPointY %}
                {% set meshPointY = meshMaxPointY %}
            {% endif %}

            {% set algorithm = "bicubic" %}
            {% if "algorithm" in bedMeshConfig %}
                {% set algorithm = bedMeshConfig.algorithm %}
            {% endif %}
            {% if meshPointX >=7 or meshPointY >=7 %}
                {% set algorithm = "bicubic" %}
            {% endif %}

            {% if enable_reference_index %}
                {% set referenceIndex = (meshPointX * meshPointY / 2 - 1 )|round(0)|int %}
                BED_MESH_CALIBRATE mesh_min={area_min_x},{area_min_y} mesh_max={area_max_x},{area_max_y} probe_count={meshPointX},{meshPointY} samples={probe_samples|int} algorithm={algorithm} relative_reference_index={referenceIndex}
            {% else %}
                BED_MESH_CALIBRATE mesh_min={area_min_x},{area_min_y} mesh_max={area_max_x},{area_max_y} probe_count={meshPointX},{meshPointY} samples={probe_samples|int} algorithm={algorithm}
            {% endif %}
        {% else %}
            BED_MESH_CALIBRATE
        {% endif %}
    {% else %}
        BED_MESH_CALIBRATE
    {% endif %}

####################################################################
# 4 - Tuning & Tests (include TEST_SPEED from the short file)
####################################################################
# Example accelerometer (commented): ADXL345 on I2C
# Add to printer.cfg (not this file) if you install an accel:
# [adxl345 my_adxl]
# cs_pin: <leave blank for I2C>
# i2c_bus: i2c1
# i2c_miso_pin:
# i2c_mosi_pin:
# i2c_scl_pin: <your board SCL>
# i2c_sda_pin: <your board SDA>
# Note: exact pin names depend on your board; check Klipper docs for correct syntax.

[gcode_macro TEST_FANS]
description: Spin fans at various speeds for testing; use params SLOW/FAST (0-255)
gcode:
    {% set slow = params.SLOW|default(100)|int %}
    {% set fast = params.FAST|default(255)|int %}
    M117 Testing fans
    M106 S{slow}
    G4 P1000
    M106 S{fast}
    G4 P1000
    M106 S0
    M117 Fan test complete
    
[gcode_macro TEST_SPEED]
gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Bounding inset for large pattern
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        {% set x_min = printer.toolhead.axis_minimum.x + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = printer.toolhead.axis_minimum.y + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    SAVE_GCODE_STATE NAME=TEST_SPEED
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }

    G28
    {% if printer.configfile.settings.quad_gantry_level %}
        {% if printer.quad_gantry_level.applied == False %}
            QUAD_GANTRY_LEVEL
            G28 Z
        {% endif %}
    {% endif %}
    G90
    G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
    G28 X Y
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
    G4 P1000
    GET_POSITION

    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}

    {% for i in range(iterations) %}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}

        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}

        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}

        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{x_center_min} F{speed*60}
    {% endfor %}

    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    G28
    G90
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
    G4 P1000
    GET_POSITION
    RESTORE_GCODE_STATE NAME=TEST_SPEED

[gcode_macro PA_TUNING_TOWER]
description: Run a pressure advance tuning tower using Klipper's TUNING_TOWER
gcode:
    {% set start = params.START|default(0)|float %}
    {% set step = params.STEP|default(0.005)|float %}
    {% set height = params.HEIGHT|default(40)|int %}
    M117 Starting PA tuning tower
    TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START={start} FACTOR={step} HEIGHT={height}
    M117 PA tuning tower started

# [gcode_macro RESONANCE_TEST]
# description: Run resonance tuning (requires accelerometer). Edit to match your accel name or uncomment accel section in printer.cfg
# gcode:
#     M117 Resonance tuning starting
#     # If you have an accel configured, run:
#     # resonance_tune
#     # After resonance_tune finishes it prints suggested input_shaper settings
#     M117 Resonance tune dispatched - run resonance_tune if accel is configured

# [gcode_macro INPUT_SHAPER_SAVE]
# description: Save input_shaper settings into config after tuning (runs SAVE_CONFIG)
# gcode:
#     M117 Saving input-shaper settings (ensure input_shaper section updated first)
#     SAVE_CONFIG
#     M117 Input-shaper save requested

# Optional template you can paste into printer.cfg after tuning:
# [input_shaper]
# shaper_type: mzv
# shaper_freq_x: 40.0
# shaper_freq_y: 38.5
# damping: 0.1
# (Replace values with those printed by resonance_tune; then run SAVE_CONFIG)

####################################################################
# 5 - Fans, LED, Snapshot, Status, etc. (taken from long file)
####################################################################
[gcode_macro HOME_ALL]
description: Home all axes cleanly (G28 wrapper)
gcode:
    M117 Homing all axes
    G28
    M117 Homing complete

# [gcode_macro POWER_ON]
# description: Turn on printer
# gcode:
#     M117 Powering ON...
#     {action_call_remote_method("set_device_power", device="printer", state="on")}
#     M117 Power ON requested

[gcode_macro POWER_OFF]
description: Safe shutdown and power off
gcode:
    M117 Shutting down...
    M104 S0
    M140 S0
    M106 S0
    G91
    G1 Z20 F1000
    G90
    G1 X10 Y10 F6000
    G4 P2000
    {action_call_remote_method("set_device_power", device="printer", state="off")}
    RESPOND TYPE=command MSG="POWER OFF requested"
    M117 PSU OFF requested

[gcode_macro QUICK_POWER_OFF]
description: Shutdown printer
gcode:
    M117 Powering OFF...
    {action_call_remote_method("set_device_power", device="printer", state="off")}
    M117 Power OFF requested

[gcode_macro PROBE_RESET]
description: Reset probe by toggling its reset pin (use when probe locks)
gcode:
    SET_PIN PIN=probe_reset_pin VALUE=1
    G4 P500
    SET_PIN PIN=probe_reset_pin VALUE=0
    G4 P100
    M117 Probe reset toggle complete

[gcode_macro LED_ON]
description: Turn status LED(s) on (pin PB8)
gcode:
    SET_PIN PIN=LED VALUE=1.0
    M117 LED on

[gcode_macro LED_OFF]
description: Turn status LED(s) off (pin PB8)
gcode:
    SET_PIN PIN=LED VALUE=0.0
    M117 LED off

[gcode_macro M300]
gcode:
    # Use a default 1kHz tone if S is omitted.
    {% set S = params.S|default(1000)|int %}
    # Use a 10ms duration is P is omitted.
    {% set P = params.P|default(100)|int %}
    SET_PIN PIN=beeper VALUE=0.5 CYCLE_TIME={ 1.0/S if S > 0 else 1 }
    G4 P{P}
    SET_PIN PIN=beeper VALUE=0

[gcode_macro BEEP_SHORT]
description: Single short beep
gcode:
    SET_PIN PIN=beeper VALUE=1
    G4 P100
    SET_PIN PIN=beeper VALUE=0

[gcode_macro BEEP_LONG]
description: Single long beep
gcode:
    SET_PIN PIN=beeper VALUE=1
    G4 P500
    SET_PIN PIN=beeper VALUE=0

[gcode_macro BEEP_DOUBLE]
description: Two quick beeps
gcode:
    SET_PIN PIN=beeper VALUE=1
    G4 P100
    SET_PIN PIN=beeper VALUE=0
    G4 P100
    SET_PIN PIN=beeper VALUE=1
    G4 P100
    SET_PIN PIN=beeper VALUE=0

[gcode_macro BEEP_ALERT]
description: Repeating triple beep (attention grabber)
gcode:
    {% for i in range(3) %}
      SET_PIN PIN=beeper VALUE=1
      G4 P200
      SET_PIN PIN=beeper VALUE=0
      G4 P200
    {% endfor %}

[gcode_macro SNAPSHOT_CAMERA]
description: Trigger a camera snapshot. Tries TAKE_PHOTO first; fallback to MJPG snapshot via ustreamer (port 8080)
gcode:
    M117 Snapshot requested
    TAKE_PHOTO
    M117 Snapshot command dispatched

[gcode_macro STATUS_REPORT]
description: Print a short status report (temperatures, bed mesh profile list)
gcode:
    M117 Status report
    TEMPERATURES
    BED_MESH_PROFILE LIST
    M117 Status report complete

[gcode_macro SAVE_CONFIG_AND_RESTART]
description: Save current config (including tuned values) and restart Klipper
gcode:
    SAVE_CONFIG
    RESTART