# ============================================
# File: 20_calibration.cfg
# Purpose: Bed and probe calibration macros
# Safe during print: NO
# Notes:
# - Includes mesh calibration, leveling, probe offsets
# - Use only when printer is idle and cold, unless temperature calibration required
# ============================================


####################################################################
# Clear Bed Mesh
####################################################################
[gcode_macro CLEAR_BED_MESH]
description: Clear current bed mesh data from memory
gcode:
    BED_MESH_CLEAR
    M117 Bed mesh cleared

####################################################################
# Calibrate Probe
####################################################################
[gcode_macro CALIBRATE_PROBE] 
description: Run Klipper's probe calibration routine and save result 
gcode: 
  G28 ; always home before probing 
  PROBE_CALIBRATE ; interactive probe calibration 
  SAVE_CONFIG

####################################################################
# Mesh - KAMP
####################################################################
[gcode_macro  MESH_CALIBRATE_KAMP]
description: Run a full bed mesh calibration (KAMP), and save result
gcode:
    G28                              ; home all axes first
    BED_MESH_CALIBRATE               ; interactive mesh probing
    SAVE_CONFIG                      ; save mesh profile as "default"
    M117 Mesh calibration complete

####################################################################
# Mesh - Legacy
####################################################################
[gcode_macro  MESH_CALIBRATE_LEGACY]
description: Run a full bed mesh calibration (legacy), and save result
gcode:
    G28                              ; home all axes first
    _BED_MESH_CALIBRATE              ; interactive mesh probing
    SAVE_CONFIG                      ; save mesh profile as "default"
    M117 Mesh calibration complete

####################################################################
# BED MESH MANAGEMENT
####################################################################
[gcode_macro MESH_SAVE]
description: Save current mesh with a profile name
gcode:
    {% set PROFILE_NAME = params.NAME|default('default')|string %}
    M117 Saving mesh: {PROFILE_NAME}
    BED_MESH_PROFILE SAVE={PROFILE_NAME}
    SAVE_CONFIG
    M117 Mesh saved: {PROFILE_NAME}

[gcode_macro MESH_LOAD]
description: Load a saved mesh profile
gcode:
    {% set PROFILE_NAME = params.NAME|default('default')|string %}
    M117 Loading mesh: {PROFILE_NAME}
    BED_MESH_PROFILE LOAD={PROFILE_NAME}
    M117 Mesh loaded: {PROFILE_NAME}

[gcode_macro MESH_CLEAR]
description: Clear the current bed mesh
gcode:
    M117 Clearing bed mesh
    BED_MESH_CLEAR
    M117 Mesh cleared

[gcode_macro MESH_LIST]
description: List all saved mesh profiles
gcode:
    M117 Listing mesh profiles
    RESPOND TYPE=command MSG="Available mesh profiles:"
    BED_MESH_PROFILE LOAD=default  # This will show available profiles in console
    M117 Check console for mesh list

####################################################################
# Preflight Check
####################################################################
[gcode_macro PREFLIGHT_CHECK]
description: Verify printer readiness before starting a print
gcode:
    M117 Running preflight check
    
    # Check if homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        RESPOND TYPE=error MSG="Printer not homed! Run G28 first"
        M117 ERROR: Not homed
        BEEP_ERROR
    {% else %}
        M117 ✓ Homing OK
    {% endif %}
    
    # Check if probe is working (if equipped)
    {% if printer.probe is defined %}
        M117 ✓ Probe detected
    {% endif %}
    
    # Check temps are safe
    {% if printer.extruder.temperature > 50 %}
        M117 ⚠ Nozzle hot: {printer.extruder.temperature}°C
    {% else %}
        M117 ✓ Temps safe
    {% endif %}
    
    M117 Preflight check complete
    BEEP_SHORT

####################################################################
# Extrusion Test
####################################################################
[gcode_macro TEST_EXTRUSION]
description: Extrude 100mm to verify extruder calibration
gcode:
    {% if printer.extruder.temperature < 200 %}
        M117 ERROR: Nozzle too cold!
        RESPOND TYPE=error MSG="Heat nozzle to at least 200°C first"
        BEEP_ERROR
    {% else %}
        M117 Extruding 100mm for calibration
        G91
        G1 E100 F100  # Extrude 100mm slowly
        G90
        M117 Extrusion test complete - measure filament
        BEEP_SHORT
    {% endif %}

####################################################################
# Heat Soak
####################################################################
[gcode_macro HEAT_SOAK]
description: Heat bed and wait for thermal equilibrium
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set DURATION = params.DURATION|default(10)|int %}
    
    M117 Heat soaking bed to {BED_TEMP}°C
    M140 S{BED_TEMP}
    M190 S{BED_TEMP}
    
    M117 Soaking for {DURATION} minutes
    G4 P{DURATION * 60000}  # Convert minutes to milliseconds
    
    BEEP_SHORT
    M117 Heat soak complete