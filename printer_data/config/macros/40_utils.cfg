# ============================================
# File: 40_utils.cfg
# Purpose: Maintenance, diagnostic, and convenience macros
# Safe during print: CONDITIONAL (depends on command)
# Notes:
# - Includes snapshot, report, save/restart utilities
# - May call printer or Moonraker APIs
# ============================================


####################################################################
# Save and Restart
####################################################################
[gcode_macro SAVE_AND_RESTART]
description: Save current config (including tuned values) and restart Klipper
gcode:
    SAVE_CONFIG
    RESTART

####################################################################
# Probe Reset
####################################################################
[gcode_macro PROBE_RESET]
description: Reset probe by toggling its reset pin (use when probe locks)
gcode:
    SET_PIN PIN=probe_reset_pin VALUE=1
    G4 P500
    SET_PIN PIN=probe_reset_pin VALUE=0
    G4 P100
    M117 Probe reset toggle complete

####################################################################
# Camera
####################################################################
[gcode_macro TAKE_PHOTO]
description: Trigger camera snapshot via mjpg-streamer
gcode:
    {% set host = params.HOST|default("localhost") %}
    {% set port = params.PORT|default("8080") %}
    {% set out = params.OUT|default("/tmp") %}
    {% set url = "http://" ~ host ~ ":" ~ port ~ "/?action=snapshot" %}
    {% set fname = "snapshot_" ~ (printer.query_endstops.time|int) ~ ".jpg" %}
    {% set msg1 = "TAKE_PHOTO: calling " ~ url %}
    {% set msg2 = "TAKE_PHOTO: saved " ~ out ~ "/" ~ fname %}

    M117 Snapshot requested
    RESPOND TYPE=command MSG="{msg1}"
    RUN_SHELL COMMAND="curl -s -o {{out}}/{{fname}} {{url}}"
    RESPOND TYPE=command MSG="{msg2}"
    M117 Snapshot saved


####################################################################
# Status
####################################################################
[gcode_macro STATUS_REPORT]
description: Print a short status report (temperatures, active mesh)
gcode:
    {% set mesh = printer.bed_mesh.profile_name if printer.bed_mesh is defined and printer.bed_mesh.profile_name is defined else "None" %}
    {% set ext = ('%.1f' % printer.extruder.temperature) if printer.extruder is defined else "N/A" %}
    {% set bed = ('%.1f' % printer.heater_bed.temperature) if printer.heater_bed is defined else "N/A" %}
    RESPOND PREFIX="STATUS" MSG="Mesh:{mesh}  Hotend:{ext}C  Bed:{bed}C"
    M105


