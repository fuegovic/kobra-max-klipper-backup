# ============================================
# File: 40_utils.cfg
# Purpose: Maintenance, diagnostic, and convenience macros
# Safe during print: CONDITIONAL (depends on command)
# Notes:
# - Includes snapshot, report, save/restart utilities
# - May call printer or Moonraker APIs
# ============================================


####################################################################
# Save and Restart
####################################################################
[gcode_macro SAVE_AND_RESTART]
description: Save current config (including tuned values) and restart Klipper
gcode:
    SAVE_CONFIG
    RESTART

####################################################################
# Probe Reset
####################################################################
[gcode_macro PROBE_RESET]
description: Reset probe by toggling its reset pin (use when probe locks)
gcode:
    SET_PIN PIN=probe_reset_pin VALUE=1
    G4 P500
    SET_PIN PIN=probe_reset_pin VALUE=0
    G4 P100
    M117 Probe reset toggle complete

####################################################################
# Camera
####################################################################
[gcode_macro TAKE_PHOTO]
description: Trigger camera snapshot via mjpg-streamer (http://host:8080/?action=snapshot)
gcode:
    {% set host = params.HOST|default("localhost") %}
    {% set port = params.PORT|default("8080") %}
    {% set out = params.OUT|default("/tmp") %}
    {% set fname = "snapshot_" + (printer.format_time("{now:%Y%m%d_%H%M%S}")) + ".jpg" %}

    M117 Snapshot requested
    RESPOND TYPE=command MSG="TAKE_PHOTO: calling http://{host}:{port}/?action=snapshot"
    RUN_SHELL COMMAND="curl -s -o {out}/{fname} http://{host}:{port}/?action=snapshot"
    RESPOND TYPE=command MSG="TAKE_PHOTO: saved {out}/{fname}"
    M117 Snapshot saved

####################################################################
# Status
####################################################################
[gcode_macro STATUS_REPORT]
description: Show short system summary
gcode:
    {% set mesh = printer.bed_mesh.profile_name if printer.bed_mesh.profile_name is defined else "None" %}
    {% set bed_temp = printer.heater_bed.temperature %}
    {% set ext_temp = printer.extruder.temperature %}
    {% set uptime = printer.system_stats.uptime %}
    RESPOND PREFIX="STATUS" MSG="Mesh:{mesh}  Hotend:{ext_temp:.1f}°C  Bed:{bed_temp:.1f}°C  Uptime:{uptime:.0f}s"

