# ============================================
# File: 11_filament.cfg
# Purpose: Filament management macros (LOAD, UNLOAD, CHANGE)
# Safe during print: ONLY via FILAMENT_CHANGE
# Notes:
# - Handles heating, retract, and priming logic
# - Use helpers from 00_helpers for consistent motion/temperature handling
# ============================================


####################################################################
# Load Filament
####################################################################
[gcode_macro LOAD_FILAMENT]
description: Heat nozzle and feed filament into hotend until primed
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = params.MAX_VELOCITY|default(1500)|int %}
    {% set temp = params.TEMP|default(220)|int %}

    SAVE_GCODE_STATE NAME=load_state
    M117 Loading filament
    M109 S{temp}                       ; wait for load temp

    G91                                  ; relative moves
    G92 E0
    G1 E100 F{max_velocity}              ; push ~100 mm quickly (adjust for your setup)
    G1 E20 F{speed}                      ; slow purge to fully prime
    RESTORE_GCODE_STATE NAME=load_state
    
####################################################################
# Unload Filament
####################################################################
[gcode_macro UNLOAD_FILAMENT]
description: Heat nozzle and retract filament fully for removal
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = params.MAX_VELOCITY|default(1500)|int %}
    {% set temp = params.TEMP|default(220)|int %}

    SAVE_GCODE_STATE NAME=unload_state
    M117 Unloading filament
    M109 S{temp}                           ; heat nozzle to unload temp

    G91                                  ; relative moves
    G92 E0
    G1 E10 F{speed}                      ; small purge to soften tip
    G1 E-50 F{max_velocity}             ; retract ~50 mm (adjust distance if needed)
    RESTORE_GCODE_STATE NAME=unload_state

####################################################################
# Filament Change
####################################################################
[gcode_macro FILAMENT_CHANGE]
description: Pause print and run a filament change workflow (heat, retract, park head)
gcode:
    M117 Filament change requested
    PAUSE
    BEEP_DOUBLE
    G91
    G1 Z10 F1000
    G90
    G1 X10 Y10 F6000
    M117 Unload/replace filament then resume