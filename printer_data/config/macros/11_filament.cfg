# ============================================
# File: 11_filament.cfg
# Purpose: Filament management macros (LOAD, UNLOAD, CHANGE)
# Safe during print: ONLY via FILAMENT_CHANGE
# Notes:
# - Handles heating, retract, and priming logic
# - Use helpers from 00_helpers for consistent motion/temperature handling
# ============================================


####################################################################
# Load Filament
####################################################################
[gcode_macro LOAD_FILAMENT]
description: Heat nozzle and feed filament into hotend until primed
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = params.MAX_VELOCITY|default(1500)|int %}
    {% set temp = params.TEMP|default(220)|int %}

    SAVE_GCODE_STATE NAME=load_state
    M117 Loading filament
    M109 S{temp}                       ; wait for load temp

    G91                                  ; relative moves
    G92 E0
    G1 E100 F{max_velocity}              ; push ~100 mm quickly (adjust for your setup)
    G1 E20 F{speed}                      ; slow purge to fully prime
    RESTORE_GCODE_STATE NAME=load_state
    
####################################################################
# Unload Filament
####################################################################
[gcode_macro UNLOAD_FILAMENT]
description: Heat nozzle and retract filament fully for removal
gcode:
    {% set speed = params.SPEED|default(1000)|int %}
    {% set max_velocity = params.MAX_VELOCITY|default(1500)|int %}
    {% set temp = params.TEMP|default(220)|int %}

    SAVE_GCODE_STATE NAME=unload_state
    M117 Unloading filament
    M109 S{temp}                           ; heat nozzle to unload temp

    G91                                  ; relative moves
    G92 E0
    G1 E10 F{speed}                      ; small purge to soften tip
    G1 E-50 F{max_velocity}             ; retract ~50 mm (adjust distance if needed)
    RESTORE_GCODE_STATE NAME=unload_state

####################################################################
# Filament Change
####################################################################
[gcode_macro FILAMENT_CHANGE]
description: Pause print and run a filament change workflow (heat, retract, park head)
gcode:
    M117 Filament change requested
    PAUSE
    BEEP_DOUBLE
    G91
    G1 Z10 F1000
    G90
    G1 X10 Y10 F6000
    M117 Unload/replace filament then resume

[gcode_macro M600]
description: Filament change (standard M600)
gcode:
    FILAMENT_CHANGE

####################################################################
# MATERIAL PRESET MACROS
####################################################################
[gcode_macro HEAT_PLA]
description: Preheat for PLA (bed 60°C, nozzle 200°C)
gcode:
    M117 Preheating for PLA
    M140 S60   # Bed to 60°C
    M104 S200  # Nozzle to 200°C
    M117 Heating to PLA temps

[gcode_macro HEAT_PETG]
description: Preheat for PETG (bed 80°C, nozzle 235°C)
gcode:
    M117 Preheating for PETG
    M140 S80   # Bed to 80°C
    M104 S235  # Nozzle to 235°C
    M117 Heating to PETG temps

[gcode_macro HEAT_ABS]
description: Preheat for ABS (bed 100°C, nozzle 245°C)
gcode:
    M117 Preheating for ABS
    M140 S100  # Bed to 100°C
    M104 S245  # Nozzle to 245°C
    M117 Heating to ABS temps - ensure ventilation!

[gcode_macro HEAT_TPU]
description: Preheat for TPU (bed 50°C, nozzle 220°C)
gcode:
    M117 Preheating for TPU
    M140 S50   # Bed to 50°C
    M104 S220  # Nozzle to 220°C
    M117 Heating to TPU temps

[gcode_macro COOLDOWN]
description: Active cooldown - run fans until temps are safe
gcode:
    M117 Starting cooldown
    M140 S0    # Bed off
    M104 S0    # Nozzle off
    M106 S255  # Fan to 100%
    
    # Wait until nozzle below 50°C
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=50
    
    M106 S0    # Fan off
    BEEP_SHORT
    M117 Cooldown complete